#!/usr/bin/env node
process.env.METALSMITH_ENV = 'development'

var dir = process.cwd()
var ms = require('../lib/index')
var log = require('../lib/log').log
var fatal = require('../lib/log').fatal
var chalk = require('chalk')
var debounce = require('debounce')
var chokidar = require('chokidar')

try {
  metalsmith = ms(dir)
} catch (e) {
  fatal(e.message)
}

var watcher = chokidar.watch(metalsmith.source(), {
  ignoreInitial: true,
  cwd: dir
})
.on('all', debounce(build, 50))
build()

log('watching for changes, ^c to abort')

function build (k) {
  var start = new Date()
  metalsmith.build(function (err) {
    var duration = new Date() - start
    if (err) {
      log('err: ' + err.message + '\n' + err.stack)
    } else {
      log(chalk.green('âœ“') + '  build ok ' + chalk.black('[' + duration + 'ms]'))
    }
  })
}
